<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Standings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
      (function () {
    const STORAGE_KEY = "__element_sdk_config__";

    let currentConfig = {};
    let handlers = {
      onConfigChange: null,
    };

    function loadConfig(defaultConfig) {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored
          ? { ...defaultConfig, ...JSON.parse(stored) }
          : { ...defaultConfig };
      } catch {
        return { ...defaultConfig };
      }
    }

    function saveConfig(cfg) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }

    window.elementSdk = {
      init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues,
      }) {
        handlers.onConfigChange = onConfigChange;

        currentConfig = loadConfig(defaultConfig);

        // Initial callback
        if (handlers.onConfigChange) {
          handlers.onConfigChange(currentConfig);
        }

        // Expose helpers for host/editor environments if needed later
        this._capabilities = mapToCapabilities
          ? mapToCapabilities(currentConfig)
          : {};

        this._editPanelValues = mapToEditPanelValues
          ? mapToEditPanelValues(currentConfig)
          : new Map();
      },

      setConfig(partialConfig) {
        currentConfig = { ...currentConfig, ...partialConfig };
        saveConfig(currentConfig);

        if (handlers.onConfigChange) {
          handlers.onConfigChange(currentConfig);
        }
      },

      getConfig() {
        return { ...currentConfig };
      },
    };
  })();
  </script>
  <script>
        (function () {
      const STORAGE_KEY = "__data_sdk_participants__";

      let data = [];
      let handler = null;

      function load() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          data = stored ? JSON.parse(stored) : [];
        } catch {
          data = [];
        }
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function notify() {
        if (handler && typeof handler.onDataChanged === "function") {
          handler.onDataChanged([...data]);
        }
      }

      function generateId() {
        return crypto.randomUUID
          ? crypto.randomUUID()
          : Math.random().toString(36).slice(2);
      }

      // NEW: keep other tabs/windows in sync
      function onStorage(e) {
        if (e.key !== STORAGE_KEY) return;
        load();
        notify();
      }

      window.dataSdk = {
        async init(dataHandler) {
          handler = dataHandler;
          load();
          notify();

          // NEW: listen once per page load
          window.removeEventListener("storage", onStorage);
          window.addEventListener("storage", onStorage);

          return { isOk: true };
        },

        async create(item) {
          const record = {
            ...item,
            __backendId: generateId(),
          };
          data.push(record);
          save();
          notify();
          return { isOk: true, value: record };
        },

        async update(updatedItem) {
          const index = data.findIndex(
            (d) => d.__backendId === updatedItem.__backendId
          );
          if (index === -1) {
            return { isOk: false };
          }

          data[index] = { ...updatedItem };
          save();
          notify();
          return { isOk: true };
        },

        async delete(item) {
          const index = data.findIndex((d) => d.__backendId === item.__backendId);
          if (index === -1) {
            return { isOk: false };
          }

          data.splice(index, 1);
          save();
          notify();
          return { isOk: true };
        },
      };
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&amp;family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    .font-display {
      font-family: 'Bebas Neue', sans-serif;
    }
    .font-body {
      font-family: 'Inter', sans-serif;
    }
    .medal-gold, .medal-silver, .medal-bronze {
      -webkit-text-fill-color: initial;
      background: none;
      font-weight: bolder;
      /* dark outline so it stays readable on light backgrounds */
      /* -webkit-text-stroke: 1px rgba(0,0,0,0.25); */
      text-shadow:
        0 2px 0 rgba(255,255,255,0.35),
        0 3px 10px rgba(0,0,0,0.25);
    }
    .medal-gold   { color: gold; }
    .medal-silver { color: silver; }
    .medal-bronze { color: #CD7F32; }
    .medal-count { font-size: 2.25rem; line-height: 1; }
    .row-hover:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .glow-gold {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    .glow-silver {
      box-shadow: 0 0 20px rgba(192, 192, 192, 0.3);
    }
    .glow-bronze {
      box-shadow: 0 0 20px rgba(205, 127, 50, 0.3);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to   { opacity: 1; transform: translate(-50%, 0); }
    }
    .toast-animate { animation: toastIn 0.3s ease-out forwards; }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    .input-dark {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .input-dark:focus {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 215, 0, 0.5);
      outline: none;
    }
  </style>
  <style>
    @view-transition { navigation: auto; }
  </style>
 </head>
 <body class="h-full font-body">
  <div id="app-wrapper" class="w-full h-full overflow-auto" style="background: linear-gradient(to bottom, #053c5a 0%, #1BA5F2 45%, rgb(86, 212, 93) 100%);">
   <div class="w-full min-h-full p-2">
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <!-- Olympic Rings Pattern - Top corners only -->
    <img src="img/torch.png" class="absolute top-2 -left-5 h-[500px] [rotate:20deg]">
    <img src="img/torch.png" class="absolute top-2 -right-5 h-[500px] [rotate:340deg]">
    <img src="img/ribbon.png" class="absolute top-60 -left-20 h-[1000px]">
    <img src="img/ribbon.png" class="absolute top-60 -right-20 h-[1000px] scale-x-[-1]">
    <img src="./img/xl-logo.png" alt="" class="h-32 w-32 absolute left-0 bottom-0 bg-white p-4">
   </div>
    
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="flex flex-col items-center gap-2 mb-6">
        <img src="img/oplympics-logo.png" class="inline-flex w-64">
      </div>
     <div class="inline-flex items-center justify-center gap-3 mb-2"><span class="text-4xl">üèÖ</span>
      <h1 id="main-title" class="font-display text-3xl tracking-wider text-white">TEAM STANDINGS</h1><span class="text-4xl">üèÖ</span>
     </div>
     <div class="h-1 w-32 mx-auto bg-gradient-to-r from-yellow-500 via-gray-300 to-amber-600 rounded-full"></div><!-- View Mode Toggle - Hidden, accessible via Ctrl+Shift+A -->
     <div class="mt-4 flex items-center justify-center gap-3 hidden"><button id="toggle-admin" onclick="toggleViewMode()" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-200 text-sm font-medium border border-white/20"> <span id="mode-icon">üë§</span> <span id="mode-text">Switch to User View</span> </button>
     </div>
    </div>
    
    <!-- Add Participant Form -->
    <div id="admin-controls" class="max-w-2xl mx-auto mb-8">
     <div class="bg-white backdrop-blur-sm rounded-2xl p-6 border-2 border-[#D6E1EA]">
      <h2 class="text-[#1F2A44] font-semibold mb-4 text-lg">Add New Participant</h2>
      <form id="add-form" class="flex flex-col sm:flex-row gap-3">
        <input type="text" id="participant-name" placeholder="Participant / Team Name" class="input-dark flex-1 px-4 py-3 rounded-xl text-[#1F2A44] font-medium border-2 border-[#D6E1EA]" style="background: rgba(217, 119, 6, 0.05)" required> 
        <button type="submit" id="add-btn" class="px-6 py-3 bg-[#F4B000] text-white font-bold rounded-xl hover:bg-[#D99800] transition-all duration-200 shadow-lg hover:shadow-yellow-500/25"> + Add </button>
      </form>
     </div>
    </div>
    
    <!-- Limit Warning -->
    <div id="limit-warning" class="hidden max-w-4xl mx-auto mb-4">
     <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-300 text-center">
      ‚ö†Ô∏è Maximum limit of 999 participants reached. Please remove some to add more.
     </div>
    </div>
    
    <!-- Standings Table -->
    <div class="max-w-4xl mx-auto">
     <div class="backdrop-blur-sm rounded-2xl border-2 border-[#D6E1EA] overflow-hidden" style="background: #F8FAFC;">
      <!-- Table Header -->
      <div class="grid grid-cols-12 items-center gap-2 p-4 bg-[#EEF4F8] border-b border-white/10">
       <div class="col-span-1"></div>
       <div class="col-span-3"></div>
       <div class="col-span-2 text-center"><span class="text-4xl" title="Gold">ü•á</span>
       </div>
       <div class="col-span-2 text-center"><span class="text-4xl" title="Silver">ü•à</span>
       </div>
       <div class="col-span-2 text-center"><span class="text-4xl" title="Bronze">ü•â</span>
       </div>
       <div class="col-span-2 flex items-center justify-center whitespace-nowrap text-4xl">ü•áü•àü•â</div>
      </div>
      
      <!-- Table Body -->
      <div id="standings-list" class="divide-y divide-white/5">
        <!-- Rows will be inserted here -->
      </div>
      
      <!-- Empty State -->
      <div id="empty-state" class="p-12 text-center">
       <div class="text-6xl mb-4">
        üèÜ
       </div>
       <p class="text-[#1F2A44] text-lg">No participants yet</p>
       <p class="text-white text-sm mt-2">Add your first participant above to start tracking medals!</p>
      </div>
     </div>
    </div>
    
    <!-- Footer -->
    <div class="text-center mt-8 text-white text-sm">
     <p id="footer-instructions">Click medal counts to edit ‚Ä¢ Sorted by Gold ‚Üí Silver ‚Üí Bronze</p>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      main_title: "TEAM STANDINGS",
      background_color: "#0f0f1a",
      text_color: "#ffffff",
      accent_color: "#ffd700",
      surface_color: "#1a1a2e",
      secondary_color: "#c0c0c0",
      font_family: "Inter",
      font_size: 16
    };

    let config = { ...defaultConfig };
    let participants = [];
    let isLoading = false;
    let isAdminMode = false; // Start in admin mode by default

    // Element SDK initialization
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: async (newConfig) => {
        config = { ...defaultConfig, ...newConfig };
        applyConfig();
      },
      mapToCapabilities: (cfg) => ({
        recolorables: [
          {
            get: () => cfg.background_color || defaultConfig.background_color,
            set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); }
          },
          {
            get: () => cfg.surface_color || defaultConfig.surface_color,
            set: (value) => { cfg.surface_color = value; window.elementSdk.setConfig({ surface_color: value }); }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (value) => { cfg.text_color = value; window.elementSdk.setConfig({ text_color: value }); }
          },
          {
            get: () => cfg.accent_color || defaultConfig.accent_color,
            set: (value) => { cfg.accent_color = value; window.elementSdk.setConfig({ accent_color: value }); }
          },
          {
            get: () => cfg.secondary_color || defaultConfig.secondary_color,
            set: (value) => { cfg.secondary_color = value; window.elementSdk.setConfig({ secondary_color: value }); }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => cfg.font_family || defaultConfig.font_family,
          set: (value) => { cfg.font_family = value; window.elementSdk.setConfig({ font_family: value }); }
        },
        fontSizeable: {
          get: () => cfg.font_size || defaultConfig.font_size,
          set: (value) => { cfg.font_size = value; window.elementSdk.setConfig({ font_size: value }); }
        }
      }),
      mapToEditPanelValues: (cfg) => new Map([
        ["main_title", cfg.main_title || defaultConfig.main_title]
      ])
    });

    function applyConfig() {
      const title = config.main_title || defaultConfig.main_title;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      document.getElementById('main-title').textContent = title;
      document.body.style.fontFamily = `${fontFamily}, Inter, sans-serif`;
      document.body.style.fontSize = `${fontSize}px`;
      
      updateViewMode();
    }

    function toggleViewMode() {
      isAdminMode = !isAdminMode;
      updateViewMode();
    }

    function updateViewMode() {
      const adminControls = document.getElementById('admin-controls');
      const footerInstructions = document.getElementById('footer-instructions');
      const modeIcon = document.getElementById('mode-icon');
      const modeText = document.getElementById('mode-text');
      
      if (isAdminMode) {
        adminControls.classList.remove('hidden');
        footerInstructions.textContent = 'Click medal counts to edit ‚Ä¢ Sorted by Gold ‚Üí Silver ‚Üí Bronze';
        modeIcon.textContent = 'üë§';
        modeText.textContent = 'Switch to User View';
      } else {
        adminControls.classList.add('hidden');
        footerInstructions.textContent = 'Sorted by Gold ‚Üí Silver ‚Üí Bronze';
        modeIcon.textContent = '‚öôÔ∏è';
        modeText.textContent = 'Switch to Admin View';
      }
      
      renderStandings();
    }

    function adjustColor(hex, amount) {
      const num = parseInt(hex.replace('#', ''), 16);
      const r = Math.min(255, Math.max(0, (num >> 16) + amount));
      const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
      const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
      return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
    }

    // Data SDK handler
    const dataHandler = {
      onDataChanged(data) {
        participants = data;
        renderStandings();
      }
    };

    async function initDataSDK() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error("Failed to initialize Data SDK");
      }
    }

    function sortParticipants(data) {
      return [...data].sort((a, b) => {
        if (b.gold !== a.gold) return b.gold - a.gold;
        if (b.silver !== a.silver) return b.silver - a.silver;
        return b.bronze - a.bronze;
      });
    }

    function renderStandings() {
      const container = document.getElementById('standings-list');
      const emptyState = document.getElementById('empty-state');
      const sorted = sortParticipants(participants);

      if (sorted.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      const existingRows = new Map(
        [...container.children].map(el => [el.dataset.id, el])
      );

      sorted.forEach((participant, index) => {
        const id = participant.__backendId;
        let row = existingRows.get(id);

        if (row) {
          updateRow(row, participant, index + 1);
          existingRows.delete(id);
        } else {
          row = createRow(participant, index + 1);
          container.appendChild(row);
        }
      });

      existingRows.forEach(el => el.remove());

      // Reorder rows to match sorted order
      sorted.forEach((participant, index) => {
        const row = container.querySelector(`[data-id="${participant.__backendId}"]`);
        if (row && row !== container.children[index]) {
          container.insertBefore(row, container.children[index]);
        }
      });
    }

    function createRow(participant, rank) {
      const row = document.createElement('div');
      row.className = 'grid grid-cols-12 gap-2 p-3 items-center row-hover transition-colors duration-200 animate-fade-in';
      row.dataset.id = participant.__backendId;
      updateRowContent(row, participant, rank);
      return row;
    }

    function updateRow(row, participant, rank) {
      updateRowContent(row, participant, rank);
    }

    function updateRowContent(row, participant, rank) {
      const canEdit = isAdminMode;
      
      row.innerHTML = `
        <div class="col-span-1 text-center">
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${getRankStyle(rank)} font-bold text-xl p-5">
            ${rank}
          </span>
        </div>
        <div class="col-span-3 text-[#474340] text-3xl font-semibold truncate">${escapeHtml(participant.name)}</div>
        <div class="col-span-2 text-center">
          ${canEdit ? `
          <button 
            onclick="editMedal('${participant.__backendId}', 'gold', ${participant.gold})"
            class="medal-count text-3xl medal-gold hover:scale-110 transition-transform cursor-pointer bg-transparent border-none"
          >
            ${participant.gold}
          </button>` : `
          <span class="text-3xl medal-gold">${participant.gold}</span>
          `}
        </div>
        <div class="col-span-2 text-center">
          ${canEdit ? `
          <button 
            onclick="editMedal('${participant.__backendId}', 'silver', ${participant.silver})"
            class="medal-count text-3xl font-bold medal-silver hover:scale-110 transition-transform cursor-pointer bg-transparent border-none"
          >
            ${participant.silver}
          </button>` : `
          <span class="text-3xl font-bold medal-silver">${participant.silver}</span>
          `}
        </div>
        <div class="col-span-2 text-center">
          ${canEdit ? `
          <button 
            onclick="editMedal('${participant.__backendId}', 'bronze', ${participant.bronze})"
            class="medal-count text-3xl font-bold medal-bronze hover:scale-110 transition-transform cursor-pointer bg-transparent border-none"
          >
            ${participant.bronze}
          </button>` : `
          <span class="text-3xl font-bold medal-bronze">${participant.bronze}</span>
          `}
        </div>
        ${canEdit ? `
        <div class="col-span-2 text-center">
          <button 
            onclick="confirmDelete('${participant.__backendId}')"
            class="text-red-500 text-lg hover:text-red-400 transition-colors p-1"
            title="Remove participant"
          >
            ‚úï
          </button>
        </div>` : `
        <div class="col-span-2 text-center">
          <div 
            class="text-[#1F2A44] text-3xl font-bold hover:text-red-400 transition-colors p-1"
            title="Total"
          >
            ${participant.gold + participant.silver + participant.bronze}
          </div>
        </div>` }
      `;
    }

    function getRankStyle(rank) {
      if (rank === 1) return 'bg-gradient-to-br from-yellow-400 to-yellow-600 text-black';
      if (rank === 2) return 'bg-gradient-to-br from-gray-300 to-gray-500 text-black';
      if (rank === 3) return 'bg-gradient-to-br from-amber-500 to-amber-700 text-black';
      return 'bg-gradient-to-br from-green-400 to-emerald-500 text-black';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let deleteConfirmId = null;

    function confirmDelete(id) {
      const row = document.querySelector(`[data-id="${id}"]`);
      const deleteBtn = row.querySelector('button[onclick^="confirmDelete"]');
      
      if (deleteConfirmId === id) {
        deleteParticipant(id);
        deleteConfirmId = null;
      } else {
        deleteConfirmId = id;
        deleteBtn.innerHTML = '‚úì';
        deleteBtn.classList.add('text-red-400');
        deleteBtn.classList.remove('text-white/30');
        
        setTimeout(() => {
          if (deleteConfirmId === id) {
            deleteBtn.innerHTML = '‚úï';
            deleteBtn.classList.remove('text-red-400');
            deleteBtn.classList.add('text-white/30');
            deleteConfirmId = null;
          }
        }, 3000);
      }
    }

    async function deleteParticipant(id) {
      if (isLoading) return;
      
      const participant = participants.find(p => p.__backendId === id);
      if (!participant) return;

      isLoading = true;
      const result = await window.dataSdk.delete(participant);
      isLoading = false;

      if (!result.isOk) {
        showToast('Failed to remove participant', 'error');
      }
    }

    function editMedal(id, type, currentValue) {
      const participant = participants.find(p => p.__backendId === id);
      if (!participant) return;

      const row = document.querySelector(`[data-id="${id}"]`);
      const buttons = row.querySelectorAll('.medal-count');
      const buttonIndex = type === 'gold' ? 0 : type === 'silver' ? 1 : 2;
      const button = buttons[buttonIndex];
      
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.value = currentValue;
      input.className = 'w-16 text-center text-2xl font-bold bg-white/10 border border-white/30 rounded-lg text-[#1F2A44] focus:outline-none focus:border-yellow-500';
      
      button.replaceWith(input);
      input.focus();
      input.select();

      async function saveValue() {
        const newValue = Math.max(0, parseInt(input.value) || 0);
        if (newValue !== currentValue) {
          const updated = { ...participant, [type]: newValue };
          isLoading = true;
          const result = await window.dataSdk.update(updated);
          isLoading = false;
          if (!result.isOk) {
            showToast('Failed to update medal count', 'error');
          }
        }
        renderStandings();
      }

      input.addEventListener('blur', saveValue);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          renderStandings();
        }
      });
    }

    function showToast(message, type = 'info') {
      const existing = document.querySelector('.toast-message');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast-message fixed bottom-4 left-1/2 px-6 py-3 rounded-xl font-medium z-50 toast-animate ${
        type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
      }`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // Form submission
    document.getElementById('add-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      
      if (participants.length >= 999) {
        document.getElementById('limit-warning').classList.remove('hidden');
        return;
      }

      const nameInput = document.getElementById('participant-name');
      const name = nameInput.value.trim();
      
      if (!name) return;

      const addBtn = document.getElementById('add-btn');
      addBtn.disabled = true;
      addBtn.textContent = 'Adding...';
      isLoading = true;

      const result = await window.dataSdk.create({
        name,
        gold: 0,
        silver: 0,
        bronze: 0,
        createdAt: new Date().toISOString()
      });

      isLoading = false;
      addBtn.disabled = false;
      addBtn.textContent = '+ Add';

      if (result.isOk) {
        nameInput.value = '';
        document.getElementById('limit-warning').classList.add('hidden');
      } else {
        showToast('Failed to add participant', 'error');
      }
    });

    // Initialize
    initDataSDK();
    applyConfig();

    // Keyboard shortcut: Ctrl+Shift+A to toggle view mode
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        toggleViewMode();
        showToast(isAdminMode ? 'Admin View Activated' : 'User View Activated', 'info');
      }
    });
  </script>
</body>
</html>